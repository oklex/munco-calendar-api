import firebase from "firebase";
import configService from "./ConfigService";

let InitializeDatabase = () => {
	let config: any = configService();
	try {
		firebase.initializeApp(config);
		InitializeFirebaseUser();
		var connectedRef = firebase.database().ref(".info/connected");
		connectedRef.on("value", function (snap: any) {
			if (snap.val() === true) {
				console.log("connected");
			} else {
				console.log("not connected");
			}
		});
	} catch (err) {
		console.log("Firebase initialization failed");
		throw err;
	}
	return config;
};

export let InitializeFirebaseUser = async () => {
	firebase
		.auth()
		.signInWithEmailAndPassword(
			process.env.ADMIN_USERNAME,
			process.env.ADMIN_PASSWORD
		)
		.then(() => {
			console.log("authenticated ", firebase.auth().currentUser.uid);
			firebase.auth().onAuthStateChanged((user) => {
				if (user) {
					console.log("App is signed in");
				} else {
					console.log("App is not signed in");
				}
			});
		})
		.catch((err) => {
			console.log(err);
			throw err;
		});
};

export let dbGetOnce = async (route: string) => {
	console.log("Firebase get: ", route);
	try {
		return await firebase
			.database()
			.ref(route)
			.once("value", (snapshot: any) => {
				return snapshot;
			});
	} catch (err) {
		console.log(err);
		throw Error(err);
	}
};

export let dbSet = async (route: string, obj: any) => {
	console.log("Firebase set: ", route, obj);
	try {
		await firebase.database().ref(route).set(obj);
	} catch (err) {
		console.log(err);
		throw Error(err);
	}
};

export let dbUpdate = async (route: string, obj: any) => {
	console.log("Firebase update: ", route, obj);
	try {
		await firebase.database().ref(route).update(obj);
	} catch (err) {
		console.log(err);
		throw Error(err);
	}
};

export let dbPush = async (route: string, obj: any) => {
	console.log("Firebase push: ", route, obj);
	try {
		await firebase.database().ref(route).push(obj);
	} catch (err) {
		console.log(err);
		throw Error(err);
	}
};

export let dbDelete = async (route: string) => {
	console.log("Firebase delete: ", route);
	try {
		await firebase.database().ref(route).remove();
	} catch (err) {
		console.log(err);
		throw Error(err);
	}
};

export let checkPathInUse = async (
	path: string,
	hasKey: string
): Promise<boolean> => {
	console.log("is path null? ", path, hasKey);
	return await firebase
		.database()
		.ref(path)
		.once("value")
		.then(async (snapshot: any) => {
			if (snapshot.hasChild(hasKey)) return true;
			else {
				console.log("path: " + path + "/" + hasKey + " is empty");
				return false;
			}
		});
};

export let saveFCMToken = (fcmToken: string) => {
	let fcmTokenPath = "/notifications/devices/"
	return firebase.database().ref(fcmTokenPath).set({
		fcmToken: true
	}).then(() => {return true}).catch((err) => {
		console.log(err);
		return false
	})
}

export default InitializeDatabase;
